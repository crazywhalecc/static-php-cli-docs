import{_ as s,c as a,o as n,U as o}from"./chunks/framework.3f05c8be.js";const u=JSON.parse('{"title":"Manual Build","description":"","frontmatter":{},"headers":[],"relativePath":"en/guide/manual-build.md","filePath":"en/guide/manual-build.md"}'),l={name:"en/guide/manual-build.md"},e=o(`<h1 id="manual-build" tabindex="-1">Manual Build <a class="header-anchor" href="#manual-build" aria-label="Permalink to &quot;Manual Build&quot;">​</a></h1><h2 id="environment-preparation" tabindex="-1">Environment Preparation <a class="header-anchor" href="#environment-preparation" aria-label="Permalink to &quot;Environment Preparation&quot;">​</a></h2><p>Currently, it supports building on macOS and Linux. macOS supports the latest version of the operating system and two architectures, while Linux supports Debian and derivative distributions, as well as Alpine Linux.</p><p>Because this project itself is developed using PHP, it is also necessary to install PHP on the system during compilation. This project also provides static binary PHP suitable for this project, which can be selected and used according to actual situations.</p><h3 id="download" tabindex="-1">Download <a class="header-anchor" href="#download" aria-label="Permalink to &quot;Download&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/crazywhalecc/static-php-cli.git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--depth=1</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">static-php-cli</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># You need to install the PHP environment first before running Composer and this project. The installation method can be referred to below.</span></span>
<span class="line"><span style="color:#FFCB6B;">composer</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span></code></pre></div><h3 id="using-system-php" tabindex="-1">Using System PHP <a class="header-anchor" href="#using-system-php" aria-label="Permalink to &quot;Using System PHP&quot;">​</a></h3><p>Below are some example commands for installing PHP and Composer in the system. It is recommended to search for the specific installation method yourself or ask the AI search engine to obtain the answer, which will not be elaborated here.</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># [macOS], need install Homebrew first. See https://brew.sh/</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Remember change your composer executable path. For M1/M2 Chip mac, &quot;/opt/homebrew/bin/&quot;, for Intel mac, &quot;/usr/local/bin/&quot;. Or add it to your own path.</span></span>
<span class="line"><span style="color:#FFCB6B;">brew</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wget</span></span>
<span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://getcomposer.org/download/latest-stable/composer.phar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-O</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/path/to/your/bin/composer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+x</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/path/to/your/bin/composer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># [Debian], you need to make sure your php version &gt;= 8.0 and composer &gt;= 2.0</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php-cli</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">composer</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php-tokenizer</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># [Alpine]</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xz</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-common</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-pcntl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-tokenizer</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-phar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-posix</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">php81-xml</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">composer</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Currently, some versions of Ubuntu install older PHP versions, so no installation commands are provided. If necessary, it is recommended to add software sources such as ppa first, and then install the latest version of PHP and tokenizer, XML, and phar extensions.</p><p>较老版本的 Debian 默认安装的可能为旧版本（&lt;= 7.4）版本的 PHP，建议先升级 Debian。</p></div><h3 id="使用-docker-环境" tabindex="-1">使用 Docker 环境 <a class="header-anchor" href="#使用-docker-环境" aria-label="Permalink to &quot;使用 Docker 环境&quot;">​</a></h3><p>如果你不愿意在系统安装 PHP 和 Composer 运行环境，可以使用内置的 Docker 环境构建脚本。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 直接使用，将所有使用的命令中 \`bin/spc\` 替换为 \`bin/spc-alpine-docker\` 即可</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc-alpine-docker</span></span></code></pre></div><p>首次执行命令会使用 <code>docker build</code> 构建一个 Docker 镜像，默认构建的 Docker 镜像为 <code>x86_64</code> 架构，镜像名称为 <code>cwcc-spc-x86_64</code>。</p><p>如果你想在 <code>x86_64</code> 环境下构建 <code>aarch64</code> 的 static-php-cli，可以使用 qemu 模拟 arm 镜像运行 Docker，但速度会非常慢。使用参数：<code>SPC_USE_ARCH=aarch64 bin/spc-alpine-docker</code>。</p><p>如果运行后提示需要 sudo 才能运行，执行一次以下命令可授予 static-php-cli 执行 sudo 的权限：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> SPC_USE_SUDO</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">yes</span></span></code></pre></div><h3 id="使用预编译静态-php-二进制" tabindex="-1">使用预编译静态 PHP 二进制 <a class="header-anchor" href="#使用预编译静态-php-二进制" aria-label="Permalink to &quot;使用预编译静态 PHP 二进制&quot;">​</a></h3><p>如果你不想使用 Docker、在系统内安装 PHP，可以直接下载本项目自身编译好的 php 二进制 cli 程序。使用流程如下：</p><p>使用命令部署环境，此脚本会从 <a href="https://dl.zhamao.xin/static-php-cli/" target="_blank" rel="noreferrer">自托管的服务器</a> 下载一个当前操作系统的 php-cli 包， 并从 <a href="https://getcomposer.org/download/latest-stable/composer.phar" target="_blank" rel="noreferrer">getcomposer</a> 或 <a href="https://mirrors.aliyun.com/composer/composer.phar" target="_blank" rel="noreferrer">Aliyun（镜像）</a> 下载 Composer。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">bin/setup-runtime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 对于中国大陆地区等网络环境特殊的用户，可使用镜像站加快下载速度</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/setup-runtime</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--mirror</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">china</span></span></code></pre></div><p>此脚本总共会下载两个文件：<code>bin/php</code> 和 <code>bin/composer</code>，下载完成后，有两种使用方式：</p><ol><li>将 <code>bin/</code> 目录添加到 PATH 路径中：<code>export PATH=&quot;/path/to/your/static-php-cli/bin:$PATH&quot;</code>，添加路径后，相当于系统安装了 PHP，可直接使用 <code>composer</code>、<code>php -v</code> 等命令，也可以直接使用 <code>bin/spc</code>。</li><li>直接调用，比如执行 static-php-cli 命令：<code>bin/php bin/spc --help</code>，执行 Composer：<code>bin/php bin/composer update</code>。</li></ol><h2 id="命令-download-下载依赖包" tabindex="-1">命令 download - 下载依赖包 <a class="header-anchor" href="#命令-download-下载依赖包" aria-label="Permalink to &quot;命令 download - 下载依赖包&quot;">​</a></h2><p>使用命令 <code>bin/spc download</code> 可以下载编译需要的源代码，包括 php-src 以及依赖的各种库的源码。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 下载所有依赖包</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">download</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--all</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 下载所有依赖包，并指定下载的 PHP 主版本，可选：8.0，8.1，8.2</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">download</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--all</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--with-php=8.2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 下载时显示下载进度条（curl）</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">download</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--all</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--debug</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 删除旧的下载数据</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">download</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--clean</span></span></code></pre></div><p>如果你所在地区的网络不好，或者下载依赖包速度过于缓慢，可以从 GitHub Action 下载每周定时打包的 <code>download.zip</code>，并使用命令直接使用 zip 压缩包作为依赖。 依赖包可以从 <a href="https://github.com/crazywhalecc/static-php-cli/actions/workflows/download-cache.yml" target="_blank" rel="noreferrer">Action</a> 下载到本地。 进入 Action 并选择一个最新成功运行的 Workflow，下载 <code>download-files-x.y</code> 即可。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">download</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--from-zip=/path/to/your/download.zip</span></span></code></pre></div><h2 id="命令-doctor-环境检查" tabindex="-1">命令 doctor - 环境检查 <a class="header-anchor" href="#命令-doctor-环境检查" aria-label="Permalink to &quot;命令 doctor - 环境检查&quot;">​</a></h2><p>如果你可以正常运行 <code>bin/spc</code> 但无法正常编译静态的 PHP 或依赖库，可以先运行 <code>bin/spc doctor</code> 检查系统自身是否缺少依赖。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 快速检查</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">doctor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 快速检查，并在可以自动修复的时候修复（使用包管理安装依赖包，仅支持上述提到的操作系统及发行版）</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">doctor</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--auto-fix</span></span></code></pre></div><h2 id="命令-build-编译-php" tabindex="-1">命令 build - 编译 PHP <a class="header-anchor" href="#命令-build-编译-php" aria-label="Permalink to &quot;命令 build - 编译 PHP&quot;">​</a></h2><p>使用 build 命令可以开始构建静态 php 二进制，在执行 <code>bin/spc build</code> 命令前，务必先使用 <code>download</code> 命令下载资源，建议使用 <code>doctor</code> 检查环境。</p><h3 id="基本用法" tabindex="-1">基本用法 <a class="header-anchor" href="#基本用法" aria-label="Permalink to &quot;基本用法&quot;">​</a></h3><p>你需要先到 <a href="./extensions.html">扩展列表</a> 或 <a href="./cli-generator.html">命令生成器</a> 选择你要加入的扩展，然后使用命令 <code>bin/spc build</code> 进行编译。你需要指定一个编译目标，从如下参数中选择：</p><ul><li><code>--build-cli</code>: 构建一个 cli sapi（命令行界面，可在命令行执行 PHP 代码）</li><li><code>--build-fpm</code>: 构建一个 fpm sapi（php-fpm，用于和其他传统的 fpm 架构的软件如 nginx 配合使用）</li><li><code>--build-micro</code>: 构建一个 micro sapi（用于构建一个包含 PHP 代码的独立可执行二进制）</li><li><code>--build-all</code>: 构建以上所有 sapi</li></ul><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 编译 PHP，附带 bcmath,curl,openssl,ftp,posix,pcntl 扩展，编译目标为 cli</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bcmath,curl,openssl,ftp,posix,pcntl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--build-cli</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 编译 PHP，附带 phar,curl,posix,pcntl,tokenizer 扩展，编译目标为 micro</span></span>
<span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">phar,curl,posix,pcntl,tokenizer</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--build-micro</span></span></code></pre></div><h3 id="调试" tabindex="-1">调试 <a class="header-anchor" href="#调试" aria-label="Permalink to &quot;调试&quot;">​</a></h3><p>如果你在编译过程中遇到了问题，或者想查看每个执行的 shell 命令，可以使用 <code>--debug</code> 开启 debug 模式，查看所有终端日志：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">bin/spc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mysqlnd,pdo_mysql</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--build-all</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--debug</span></span></code></pre></div><h3 id="编译运行选项" tabindex="-1">编译运行选项 <a class="header-anchor" href="#编译运行选项" aria-label="Permalink to &quot;编译运行选项&quot;">​</a></h3><p>在编译过程中，有些特殊情况需要对编译器、编译目录的内容进行干预，可以尝试使用以下命令：</p><ul><li><code>--cc=XXX</code>: 指定 C 语言编译器的执行命令（Linux 默认 <code>musl-gcc</code> 或 <code>gcc</code>，macOS 默认 <code>clang</code>）</li><li><code>--cxx=XXX</code>: 指定 C++ 语言编译器的执行命令（Linux 默认 <code>g++</code>，macOS 默认 <code>clang++</code>）</li><li><code>--with-clean</code>: 编译 PHP 前先清理旧的 make 产生的文件</li><li><code>--enable-zts</code>: 让编译的 PHP 为线程安全版本（默认为 NTS 版本）</li><li><code>--no-strip</code>: 编译 PHP 库后不运行 <code>strip</code> 裁剪二进制文件缩小体积（不裁剪的 macOS 二进制文件可使用动态链接的第三方扩展）</li><li><code>--with-libs=XXX,YYY</code>: 编译 PHP 前先编译指定的依赖库，激活部分扩展的可选功能（例如 gd 库的 libavif 等）</li></ul>`,43),p=[e];function t(c,i,r,d,C,h){return n(),a("div",null,p)}const b=s(l,[["render",t]]);export{u as __pageData,b as default};
